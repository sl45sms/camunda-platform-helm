version: '3'

env:
  TEST_NAMESPACE: '{{ env "TEST_NAMESPACE" | default "camunda-platform" }}'
  CHART_DIR: ../../../../charts/camunda-platform
  FIXTURES_DIR: ../../fixtures

includes:
  test.secret: ../lib/testsuite-secret-taskfile.yaml
  test.preflight:
    taskfile: ../lib/testsuite-deploy-taskfile.yaml
    vars:
      testID: preflight
  test.core:
    taskfile: ../lib/testsuite-deploy-taskfile.yaml
    vars:
      testID: core

tasks:
  setup.pre:
    cmds:
    # This is needed to access WebModeler Docker image. It will be removed once WebModeler is public.
    - kubectl create secret generic registry-camunda-cloud
        --namespace $TEST_NAMESPACE
        --from-file .dockerconfigjson=$DOCKER_CONFIG_FILE
        --type kubernetes.io/dockerconfigjson

  setup.exec:
    deps:
    - test.secret
    cmds:
    - helm install integration $CHART_DIR
        --namespace $TEST_NAMESPACE
        --values $FIXTURES_DIR/values-identity-test-client.yaml
        --values $FIXTURES_DIR/values-enable-readiness.yaml
        --values ./values-web-modeler-enabled.yaml
        --timeout 15m0s
        --wait

  setup.post:
    cmds:
    - echo "No post task for this test."

  default:
    cmds:
    - task: setup.pre
    - task: setup.exec
    - task: setup.post
    - task: test.preflight
    - task: test.core