version: '3'

vars:
  TEST_NAMESPACE: '{{ env "TEST_NAMESPACE" | default "camunda-platform" }}'
  TEST_CLUSTER_TYPE: '{{ env "TEST_CLUSTER_TYPE" | default "kubernetes" }}'
  HELM_EXTRA_ARGS: '{{ env "HELM_EXTRA_ARGS" }} {{ .OPENSHIFT_ARGS }}'

dotenv:
- ../../fixtures/vars.env
- ../../fixtures/{{ .TEST_CLUSTER_TYPE }}.env

includes:
  test.preflight:
    taskfile: ../lib/testsuite-deploy-taskfile.yaml
    vars:
      testID: preflight
  test.core:
    taskfile: ../lib/testsuite-deploy-taskfile.yaml
    vars:
      testID: core

tasks:
  setup.pre:
    cmds:
    # This is needed to access WebModeler Docker image. It will be removed once WebModeler is public.
    - kubectl create secret generic registry-camunda-cloud
        --namespace {{ .TEST_NAMESPACE }}
        --from-file .dockerconfigjson=$DOCKER_CONFIG_FILE
        --type kubernetes.io/dockerconfigjson

  setup.exec:
    cmds:
    - helm install integration {{ .CHART_DIR }}
        --namespace {{ .TEST_NAMESPACE }}
        --values {{ .FIXTURES_DIR }}/values-integration-test.yaml
        --values ./values-web-modeler-enabled.yaml
        --timeout 15m0s
        --wait
        {{ .HELM_EXTRA_ARGS }}

  setup.post:
    cmds:
    - echo "No post task for this test."

  all:
    cmds:
    - task: setup.pre
    - task: setup.exec
    - task: setup.post
    - task: test.preflight
    - task: test.core